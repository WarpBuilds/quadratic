use std::fs::create_dir_all;

use quadratic_core::color::Rgba;
use quadratic_core::controller::active_transactions::transaction_name::TransactionName;
use quadratic_core::controller::execution::run_code::get_cells::CellA1Response;
use quadratic_core::controller::execution::run_code::get_cells::JsGetCellResponse;
use quadratic_core::controller::operations::clipboard::PasteSpecial;
use quadratic_core::controller::transaction_types::JsCodeResult;
use quadratic_core::grid::formats::Format;
use quadratic_core::grid::js_types::{
    CellFormatSummary, JsCellValue, JsCellValuePos, JsCellValuePosAIContext, JsClipboard,
    JsCodeCell, JsHtmlOutput, JsNumber, JsOffset, JsRenderCell, JsRenderCellSpecial,
    JsRenderCodeCell, JsRenderCodeCellState, JsRenderFill, JsReturnInfo, JsRowHeight, JsSheetFill,
    JsSummarizeSelectionResult, JsValidationWarning,
};
use quadratic_core::grid::sheet::borders::{BorderStyleCell, BorderStyleTimestamp};
use quadratic_core::grid::sheet::borders_a1::BorderSide;
use quadratic_core::grid::sheet::borders_a1::JsBorder;
use quadratic_core::grid::sheet::jump_cursor::JumpDirection;
use quadratic_core::grid::sheet::search::SearchOptions;
use quadratic_core::grid::sheet::validations::validation::{
    Validation, ValidationError, ValidationMessage, ValidationStyle,
};
use quadratic_core::grid::sheet::validations::validation_rules::validation_date_time::{
    DateTimeRange, ValidationDateTime,
};
use quadratic_core::grid::sheet::validations::validation_rules::validation_list::{
    ValidationList, ValidationListSource,
};
use quadratic_core::grid::sheet::validations::validation_rules::validation_logical::ValidationLogical;
use quadratic_core::grid::sheet::validations::validation_rules::validation_number::{
    NumberRange, ValidationNumber,
};
use quadratic_core::grid::sheet::validations::validation_rules::validation_text::{
    TextCase, TextMatch, ValidationText,
};
use quadratic_core::grid::sheet::validations::validation_rules::ValidationRule;
use quadratic_core::grid::{
    BorderSelection, BorderStyle, CellBorderLine, CodeCellLanguage, ConnectionKind,
};
use quadratic_core::grid::{
    CellAlign, CellVerticalAlign, CellWrap, GridBounds, NumericFormat, NumericFormatKind, SheetId,
};
use quadratic_core::grid::{JsCellsAccessed, RenderSize};
use quadratic_core::sheet_offsets::resize_transient::TransientResize;
use quadratic_core::sheet_offsets::sheet_offsets_wasm::ColumnRow;
use quadratic_core::small_timestamp::SmallTimestamp;
use quadratic_core::wasm_bindings::controller::sheet_info::{SheetBounds, SheetInfo};
use quadratic_core::A1Selection;
use quadratic_core::CellRefCoord;
use quadratic_core::CellRefRangeEnd;
use quadratic_core::RefRangeBounds;
use quadratic_core::{
    ArraySize, Axis, CellRefRange, JsCoordinate, Pos, Rect, RunError, RunErrorMsg, SheetPos,
    SheetRect, Span,
};
use ts_rs::TS;

macro_rules! generate_type_declarations {
    ($($type:ty),+ $(,)?) => {
        String::new() $(+ "export " + &<$type>::decl() + "\n")+
    };
}

fn main() {
    // TODO: autogenerate this file by parsing the whole project using `syn` and
    // searching for types annotated with `#[derive(TS)]`. This still won't work
    // for types generated by `macro_rules!` macros, so we'll have to handle
    // those some other way.
    let mut s = format!("// This file is automatically generated by {}\n", file!());
    s += "// Do not modify it manually.\n\n";

    s += &generate_type_declarations!(
        A1Selection,
        ArraySize,
        Axis,
        BorderSelection,
        BorderSide,
        BorderStyle,
        BorderStyleCell,
        BorderStyleTimestamp,
        CellA1Response,
        CellAlign,
        CellBorderLine,
        CellFormatSummary,
        CellRefCoord,
        CellRefRange,
        CellRefRangeEnd,
        CellVerticalAlign,
        CellWrap,
        CodeCellLanguage,
        ColumnRow,
        ConnectionKind,
        DateTimeRange,
        Format,
        GridBounds,
        JsBorder,
        JsCellsAccessed,
        JsCellValue,
        JsCellValuePos,
        JsCellValuePosAIContext,
        JsClipboard,
        JsCodeCell,
        JsCodeResult,
        JsCoordinate,
        JsGetCellResponse,
        JsHtmlOutput,
        JsNumber,
        JsOffset,
        JsRenderCell,
        JsRenderCellSpecial,
        JsRenderCodeCell,
        JsRenderCodeCellState,
        JsRenderFill,
        JsReturnInfo,
        JsRowHeight,
        JsSheetFill,
        JsSummarizeSelectionResult,
        JsValidationWarning,
        JumpDirection,
        NumberRange,
        NumericFormat,
        NumericFormatKind,
        PasteSpecial,
        Pos,
        RefRangeBounds,
        Rect,
        RenderSize,
        Rgba,
        RunError,
        RunErrorMsg,
        SearchOptions,
        SheetBounds,
        SheetId,
        SheetInfo,
        SheetPos,
        SheetRect,
        SmallTimestamp,
        Span,
        TextCase,
        TextMatch,
        TransactionName,
        TransientResize,
        Validation,
        ValidationDateTime,
        ValidationError,
        ValidationList,
        ValidationListSource,
        ValidationLogical,
        ValidationMessage,
        ValidationNumber,
        ValidationRule,
        ValidationStyle,
        ValidationText
    );

    if create_dir_all("../quadratic-client/src/app/quadratic-core-types").is_ok() {
        std::fs::write(
            "../quadratic-client/src/app/quadratic-core-types/index.d.ts",
            s,
        )
        .expect("failed to write types file");
    }
}
