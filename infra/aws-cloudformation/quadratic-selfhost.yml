AWSTemplateFormatVersion: 2010-09-09
Description: Quadratic Preview - DockerDeployment Template

Parameters:
  ImageTag:
    Type: String
    Description: Image tag to use for all services

Resources:
  # Security Group for the EC2 instance
  SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      Tags:
        - Key: Name
          Value: !Ref ImageTag
      GroupDescription: !Ref ImageTag
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0

  # IAM Role for the EC2 instance
  EC2Role:
    Type: AWS::IAM::Role
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      Tags:
        - Key: Name
          Value: !Ref ImageTag
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
        - arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly
        - arn:aws:iam::aws:policy/AmazonSSMReadOnlyAccess

  # IAM Instance Profile for the EC2 instance
  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      Roles:
        - !Ref EC2Role

  # EC2 instance
  EC2Instance:
    Type: AWS::EC2::Instance
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      Tags:
        - Key: Name
          Value: !Sub "${ImageTag}"
      InstanceType: m6a.large
      ImageId: ami-094c4f62c0fffae5e # quadratic-selfhost-base-ami
      IamInstanceProfile: !Ref EC2InstanceProfile
      SecurityGroups:
        - !Ref SecurityGroup
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            VolumeSize: 30
            VolumeType: gp3
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash

          # Append environment variables to .env file
          cat << EOF >> /quadratic-selfhost/.env.docker

          AWS_S3_REGION=$(aws ssm get-parameter --name "/quadratic-development/AWS_S3_REGION" --with-decryption --query "Parameter.Value" --output text)
          AWS_S3_ACCESS_KEY_ID=$(aws ssm get-parameter --name "/quadratic-development/AWS_S3_ACCESS_KEY_ID" --with-decryption --query "Parameter.Value" --output text)
          AWS_S3_SECRET_ACCESS_KEY=$(aws ssm get-parameter --name "/quadratic-development/AWS_S3_SECRET_ACCESS_KEY" --with-decryption --query "Parameter.Value" --output text)

          # AI API Keys
          OPENAI_API_KEY=$(aws ssm get-parameter --name "/quadratic-development/OPENAI_API_KEY" --with-decryption --query "Parameter.Value" --output text)
          ANTHROPIC_API_KEY=$(aws ssm get-parameter --name "/quadratic-development/ANTHROPIC_API_KEY" --with-decryption --query "Parameter.Value" --output text)
          EXA_API_KEY=$(aws ssm get-parameter --name "/quadratic-development/EXA_API_KEY" --with-decryption --query "Parameter.Value" --output text)

          # aws ecr
          ECR_URL=${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com
          IMAGE_TAG=${ImageTag}
          EOF

          # Create login.sh script and run it
          cat << 'EOF' > /quadratic-selfhost/login.sh
          #!/bin/bash
          aws ecr get-login-password --region ${AWS::Region} | docker login --username AWS --password-stdin ${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com
          EOF

          chmod +x /quadratic-selfhost/login.sh
          cd /quadratic-selfhost
          ./login.sh

          # Run Quadratic initialization script
          ./init.sh "$(aws ssm get-parameter --name "/quadratic-development/QUADRATIC_LICENSE_KEY" --with-decryption --query "Parameter.Value" --output text)" "${ImageTag}.quadratic-selfhost.com"

  # Global Accelerator
  GlobalAccelerator:
    Type: AWS::GlobalAccelerator::Accelerator
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      Name: !Sub "${ImageTag}"
      Enabled: true
      Tags:
        - Key: Name
          Value: !Ref ImageTag

  # Global Accelerator Listener
  GlobalAcceleratorListener:
    Type: AWS::GlobalAccelerator::Listener
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      AcceleratorArn: !Ref GlobalAccelerator
      Protocol: TCP
      PortRanges:
        - FromPort: 80
          ToPort: 80
        - FromPort: 443
          ToPort: 443

  # Global Accelerator Endpoint Group
  GlobalAcceleratorEndpointGroup:
    Type: AWS::GlobalAccelerator::EndpointGroup
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      ListenerArn: !Ref GlobalAcceleratorListener
      EndpointGroupRegion: !Ref AWS::Region
      EndpointConfigurations:
        - EndpointId: !Ref EC2Instance
          Weight: 100
          ClientIPPreservationEnabled: true

  # DNS record for the main application
  DNSRecord:
    Type: AWS::Route53::RecordSet
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      HostedZoneId: Z08322143IM80L9CZZQV5
      Name: !Sub "${ImageTag}.quadratic-selfhost.com."
      Type: A
      AliasTarget:
        DNSName: !GetAtt GlobalAccelerator.DnsName
        HostedZoneId: Z2BJ6XQ5FK7U4H
        EvaluateTargetHealth: true

  # Wildcard DNS record for all services on subdomains
  WildcardDNSRecord:
    Type: AWS::Route53::RecordSet
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      HostedZoneId: Z08322143IM80L9CZZQV5
      Name: !Sub "*.${ImageTag}.quadratic-selfhost.com."
      Type: A
      AliasTarget:
        DNSName: !GetAtt GlobalAccelerator.DnsName
        HostedZoneId: Z2BJ6XQ5FK7U4H
        EvaluateTargetHealth: true

Outputs:
  WebsiteURL:
    Description: Website URL
    Value: !Sub "https://${ImageTag}.quadratic-selfhost.com"
